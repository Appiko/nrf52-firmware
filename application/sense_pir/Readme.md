/**
@addtogroup sense_appln
@{


# SensePi Firmware:

[SensePi] (https://appiko.org/sensepi.html) is a motion based camera triggering device. This device can be used 
to trigger DSLRs and Point and Shoot cameras. This device can be used as trigger 
for other systems as well. 

There is no active sensor being used in this device. That's why it's very battery
efficient. 



## Application Explanation

SensePi Firmware is an application which handles multiple modules which serves 
different purpose like handling camera triggering, wireless connection, data 
storage into non volatile memory.

This application also serves events generated by some modules like button
press module, add tick module, etc.

### Working Principle:

SensePi Firmware works on event driven principle. That means core will wake-up
only when some interrupt or events happens. Other times it'll be in sleep mode. 
This will result into drastic drop in power consumption. Also by making it event 
driven it's response latency is very low. There are almost no instructions to 
perform between event and handler operations. Response time of device is very low.
Control diagram will explain how program's flow is.

Firmware's working can be explained as a state machine having 3 states. 
Application will be always in one these states. These states are:

 - Advertisement
 - Connected
 - Sensing

In each state different sets of peripheral modules are active or serving different
requests. 

#### 1 Advertisement : 
In this state device's Bluetooth is on and ready to connect. Bluetooth 4.0 
protocol is used over here, so to understand different states related Bluetooth 4.0
read this article. In advertisement device will continuously transmit specified 
data with certain time difference. Then user can connect to device using 'Appiko
setup' app or 'nrf Connect' app. Timeout for this state is 5 mins. 

#### 2 Connected : 

In this state device's Bluetooth is active but it is connected to certain device
and hence cant connect to other devices. User can send configurations from mobile 
to device. Timeout for this state is 10 mins.

#### 3 Sensing : 

This is the default state for device. After Timeout or after disconnect SensePi 
will comeback in this state. This state handles PIR sensing & camera triggering.
There is no timeout for this state. 

By using this state machine approach we were able to avoid a lot of conflicting
scenarios 

### Control Flow Diagram :

The state diagram for SensePi is given below:

![state_diagram](https://github.com/Appiko/nrf5x-firmware/blob/master/application/sense_pir/state_diagram.svg)

As one can see, the default state when SensePi starts it's operation is Sensing. 
If someone presses button present on SensePi, it'll go into Advertising state. 
There it'll wit for 3 mins for Connection request. If it receives connection request 
before 3 mins over, it'll connect with the requesting device. 

Once SensePi connects with some device, it can remain in this state for 10 mins. 
After 10 mins timeout will occur and it'll go back to Sensing state. If user have 
proper mobile device and proper application to change the configuration, user can 
do it in these 10 mins. And user can also terminate connection by sending disconnect 
request. 

This State machine implementation is done by building firmware application in a 
modular structure. There are 3 supporting modules which handles different aspects 
of firmware. Those modules are :

 1. Bluetooth communication module
 1. Camera triggering module
 1. Data storage module

Interaction between these modules and application can be represented as follow :

![modular_interaction](https://github.com/Appiko/nrf5x-firmware/blob/master/application/sense_pir/modular_interaction.svg)

As We can observe over there, all modules interact with main application directly. 
Almost all the inter-module communication is done through main application. Only 
once direct communication between two module happens when Camera module saves 
latest configuration in Flash memory through Data storage module. Passing of new 
configuration from Bluetooth communication module to camera trigger module is also 
done through main application. 

On system power reset or firmware update, main application will load the latest 
configuration present in flash memory through Data storage module and will pass it 
on to Camera trigger module.

## Different Modules of application
### Bluetooth communication module

This module handles Bluetooth communication. i.e. this module decides what kind of
data is to be sent over Bluetooth. Structure which is to be used to send the 
data over Bluetooth is defined in this module. This module also handles how to 
serve different requests that it might get while using Bluetooth to communicate 
with other devices. One can refer to data structures over here.(link)

### Camera triggering module

This module handles operation of device when it's in sensing state. This module
handles the camera triggering related operations. This module uses the data sent by
mobile device to Bluetooth communication module and does the required configurations.
 These configurations contains mode of operation (i.e. timer, motion or both),
 light conditions (i.e day, night or both), type of trigger (different modes in 
which cameras can be triggered). 

### Data storage Module

This module handles the storage if data such as current config and firmware id in 
permanent memory. This data enables device to restore the configuration data after 
OTA update is done or if power supply gets disturbed. This module uses flash memory 
to store the data 


@}
*/
